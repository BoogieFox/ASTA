<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'G√©rer ' + ${apprenti.prenom} + ' ' + ${apprenti.nom} + ' - ASTA'">G√©rer l'apprenti - ASTA</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .section-card {
            margin-bottom: 1.5rem;
        }
        
        .card-header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: var(--background);
            border-bottom: 1px solid var(--border-color);
            border-radius: 0.5rem 0.5rem 0 0;
        }
        
        .card-header-actions h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
        }
        
        .error-message {
            display: block;
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            font-weight: 500;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .hidden {
            display: none;
        }
        
        .info-section {
            margin-bottom: 1.5rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .item-card {
            background-color: var(--background);
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            border-left: 3px solid var(--primary-color);
        }
        
        .item-empty {
            background-color: var(--background);
            padding: 2rem;
            border-radius: 0.375rem;
            text-align: center;
            color: var(--text-secondary);
            border: 2px dashed var(--border-color);
        }
        
        .item-field {
            display: flex;
            margin-bottom: 0.5rem;
        }
        
        .item-field:last-child {
            margin-bottom: 0;
        }
        
        .field-label {
            font-weight: 600;
            width: 150px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .field-value {
            flex: 1;
            color: var(--text-primary);
        }
        
        .alert-success {
            background-color: #d1f2df;
            border: 1px solid #b0e2c0;
            color: #0f5132;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .alert-error {
            background-color: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .view-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-secondary);
        }

        .select-with-add {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .select-with-add select {
            flex: 1;
        }

        /* Styles pour les formulaires d√©roulants */
        .collapsible-form {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin 0.3s ease-out;
            margin-bottom: 0;
        }

        .collapsible-form.show {
            max-height: 1000px;
            opacity: 1;
            margin-bottom: 1rem;
        }

        .collapsible-form.hidden {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/apprentis" class="navbar-brand">ASTA</a>
            <ul class="navbar-menu">
                <li><a href="/apprentis">Accueil</a></li>
                <li>
                    <form th:action="@{/logout}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-secondary btn-small">D√©connexion</button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <div class="page-header-actions">
                <h1 th:text="'‚öôÔ∏è G√©rer - ' + ${apprenti.prenom} + ' ' + ${apprenti.nom}">‚öôÔ∏è G√©rer - Apprenti</h1>
                <div>
                    <a href="/apprentis" class="btn btn-secondary">Retour √† la liste</a>
                </div>
            </div>
        </div>

        <!-- Message de succ√®s -->
        <div id="successMessage" class="alert-success hidden">
            ‚úÖ Les informations ont √©t√© sauvegard√©es avec succ√®s !
        </div>
        
        <!-- Message de succ√®s depuis le FlashAttribute -->
        <div th:if="${successMessage}" class="alert-success">
            <span th:text="${successMessage}"></span>
        </div>

        <!-- Message d'erreur global (sauf erreurs contextuelles) -->
        <div th:if="${errorMessage != null and !#strings.startsWith(errorMessage, 'VISITE:') and !#strings.startsWith(errorMessage, 'SOUTENANCE:') and !#strings.startsWith(errorMessage, 'RAPPORT:')}"
             class="alert-error">
            <span th:text="${errorMessage}"></span>
        </div>

        <!-- Section Informations Personnelles -->
        <div class="card section-card">
            <div class="card-header-actions">
                <h2>üìã Informations personnelles</h2>
            </div>
            <div class="card-body">
                <form id="form-info-personnelles" th:action="@{/apprentis/{id}/informations(id=${apprenti.apprentiId})}" method="post" th:object="${modifierApprentiDto}">
                    <!-- Support de PATCH pour Thymeleaf -->
                    <input type="hidden" name="_method" value="PATCH"/>
                    
                    <div class="form-group">
                        <label for="nom">Nom *</label>
                        <input type="text" id="nom" th:field="*{nom}" required>
                        <span class="error-message" th:if="${#fields.hasErrors('nom')}" th:errors="*{nom}"></span>
                    </div>
                    <div class="form-group">
                        <label for="prenom">Pr√©nom *</label>
                        <input type="text" id="prenom" th:field="*{prenom}" required>
                        <span class="error-message" th:if="${#fields.hasErrors('prenom')}" th:errors="*{prenom}"></span>
                    </div>
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" th:field="*{email}" required>
                        <span class="error-message" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></span>
                    </div>
                    <div class="form-group">
                        <label for="telephone">T√©l√©phone *</label>
                        <input type="tel" id="telephone" th:field="*{telephone}" required>
                        <span class="error-message" th:if="${#fields.hasErrors('telephone')}" th:errors="*{telephone}"></span>
                    </div>
                    <div class="form-group">
                        <label for="majeure">Majeure *</label>
                        <input type="text" id="majeure" th:field="*{majeure}" required>
                        <span class="error-message" th:if="${#fields.hasErrors('majeure')}" th:errors="*{majeure}"></span>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary">Modifier</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Section Entreprise -->
        <div class="card section-card editable-section view-mode" id="section-entreprise">
            <div class="card-header-actions">
                <h2>üè¢ Entreprise</h2>
                <button type="button" class="btn btn-primary btn-small" onclick="toggleEdit('entreprise')">
                    <span class="edit-text">Modifier</span>
                    <span class="save-text hidden">Enregistrer</span>
                </button>
            </div>
            <div class="card-body">
                <!-- Mode consultation -->
                <div class="view-content">
                    <div class="form-group" th:if="${apprenti.entreprise != null}">
                        <span class="view-label">Raison Sociale :</span>
                        <div class="value" id="view-entreprise" th:text="${apprenti.entreprise.raisonSociale}">-</div>
                    </div>
                    <div class="form-group" th:if="${apprenti.entreprise != null}">
                        <span class="view-label">Adresse :</span>
                        <div class="value" id="view-adresse" th:text="${apprenti.entreprise.adresse}">-</div>
                    </div>
                    <div class="form-group" th:if="${apprenti.entreprise != null && apprenti.entreprise.informationsLocaux != null}">
                        <span class="view-label">Informations sur les locaux :</span>
                        <div class="value" id="view-locaux" th:text="${apprenti.entreprise.informationsLocaux}">-</div>
                    </div>
                    <div class="form-group" th:if="${apprenti.entreprise == null}">
                        <span class="view-label">Entreprise :</span>
                        <div class="value">Aucune entreprise associ√©e</div>
                    </div>
                </div>
                
                <!-- Mode √©dition -->
                <div class="edit-content hidden">
                    <form id="form-entreprise">
                        <div class="form-group">
                            <label for="entreprise">Entreprise *</label>
                            <div class="select-with-add">
                                <select id="entreprise" name="entreprise" required>
                                    <option value="">-- S√©lectionner une entreprise --</option>
                                    <option th:each="entreprise : ${entreprises}"
                                            th:value="${entreprise.entrepriseId}"
                                            th:text="${entreprise.raisonSociale}"
                                            th:selected="${apprenti.entreprise != null && entreprise.entrepriseId == apprenti.entreprise.entrepriseId}">
                                        Entreprise
                                    </option>
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="redirectToNouvelleEntreprise()">+ Nouvelle Entreprise</button>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('entreprise')">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Section Ma√Ætre d'Apprentissage -->
        <div class="card section-card editable-section view-mode" id="section-maitre">
            <div class="card-header-actions">
                <h2>üëî Ma√Ætre d'Apprentissage</h2>
                <button type="button" class="btn btn-primary btn-small" onclick="toggleEdit('maitre')">
                    <span class="edit-text">Modifier</span>
                    <span class="save-text hidden">Enregistrer</span>
                </button>
            </div>
            <div class="card-body">
                <!-- Mode consultation -->
                <div class="view-content">
                    <div th:if="${apprenti.maitreApprentissage != null}">
                        <div class="form-group">
                            <span class="view-label">Nom :</span>
                            <div class="value" id="view-maitre-nom" th:text="${apprenti.maitreApprentissage.nom + ' ' + apprenti.maitreApprentissage.prenom}">-</div>
                        </div>
                        <div class="form-group">
                            <span class="view-label">Poste :</span>
                            <div class="value" id="view-maitre-poste" th:text="${apprenti.maitreApprentissage.poste}">-</div>
                        </div>
                        <div class="form-group">
                            <span class="view-label">Email :</span>
                            <div class="value" id="view-maitre-email" th:text="${apprenti.maitreApprentissage.email}">-</div>
                        </div>
                        <div class="form-group">
                            <span class="view-label">T√©l√©phone :</span>
                            <div class="value" id="view-maitre-telephone" th:text="${apprenti.maitreApprentissage.telephone}">-</div>
                        </div>
                    </div>
                    <div class="form-group" th:if="${apprenti.maitreApprentissage == null}">
                        <span class="view-label">Ma√Ætre d'Apprentissage :</span>
                        <div class="value">Aucun ma√Ætre d'apprentissage associ√©</div>
                    </div>
                </div>
                
                <!-- Mode √©dition -->
                <div class="edit-content hidden">
                    <form id="form-maitre">
                        <div class="form-group">
                            <label for="maitre">Ma√Ætre d'Apprentissage *</label>
                            <div class="select-with-add">
                                <select id="maitre" name="maitre" required>
                                    <option value="">-- S√©lectionner un ma√Ætre --</option>
                                    <option th:each="maitre : ${maitresApprentissage}"
                                            th:value="${maitre.maitreApprentissageId}"
                                            th:text="${maitre.nom + ' ' + maitre.prenom + ' - ' + maitre.poste}"
                                            th:selected="${apprenti.maitreApprentissage != null && maitre.maitreApprentissageId == apprenti.maitreApprentissage.maitreApprentissageId}">
                                        Ma√Ætre
                                    </option>
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="redirectToNouveauMaitre()">+ Nouveau Ma√Ætre</button>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-secondary" onclick="cancelEdit('maitre')">Annuler</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Dossier annuel courant -->
        <div class="card section-card">
            <div class="card-header-actions">
                <h2>
                    üìÅ Dossier annuel
                    <span th:text="'- ' + ${apprenti.promotion.label}">- Promotion</span>
                </h2>
            </div>
            <div class="card-body">
                <div th:if="${dossierCourant != null}">
                    <div class="info-section">
                        <div class="section-header">
                            <div class="section-title">üìÖ Visite</div>
                            <div>
                                <button th:if="${dossierCourant.visite == null}"
                                        type="button"
                                        class="btn btn-primary btn-small"
                                        onclick="toggleAddForm('visite')">+ Ajouter</button>
                                <button th:if="${dossierCourant.visite != null}"
                                        type="button"
                                        class="btn btn-primary btn-small"
                                        onclick="toggleEditForm('visite')">‚úèÔ∏è Modifier</button>
                                <form th:if="${dossierCourant.visite != null}"
                                      th:action="@{/dossiers/visite/{visiteId}/supprimer(visiteId=${dossierCourant.visite.visiteId})}"
                                      method="post"
                                      style="display: inline;">
                                    <input type="hidden" name="apprentiId" th:value="${apprenti.apprentiId}">
                                    <button type="submit" class="btn btn-secondary btn-small" onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer cette visite ?')">üóëÔ∏è Supprimer</button>
                                </form>
                            </div>
                        </div>

                        <!-- Message d'erreur contextuel pour la visite -->
                        <div th:if="${errorMessage != null and #strings.startsWith(errorMessage, 'VISITE:')}"
                             class="alert-error"
                             style="margin-bottom: 1rem;">
                            <span th:utext="${#strings.substringAfter(errorMessage, 'VISITE:')}"></span>
                        </div>

                        <!-- Affichage des donn√©es existantes -->
                        <div id="view-visite" th:if="${dossierCourant.visite != null}" class="item-card">
                            <div class="item-field">
                                <div class="field-label">Date :</div>
                                <div class="field-value" th:text="${#temporals.format(dossierCourant.visite.date, 'dd/MM/yyyy')}">-</div>
                            </div>
                            <div class="item-field" th:if="${dossierCourant.visite.format != null}">
                                <div class="field-label">Format :</div>
                                <div class="field-value" th:text="${dossierCourant.visite.format}">-</div>
                            </div>
                            <div class="item-field" th:if="${dossierCourant.visite.commentaires != null}">
                                <div class="field-label">Commentaires :</div>
                                <div class="field-value" th:text="${dossierCourant.visite.commentaires}">-</div>
                            </div>
                        </div>

                        <!-- Message vide -->
                        <div th:if="${dossierCourant.visite == null}" class="item-empty">
                            Aucune visite enregistr√©e. Cliquez sur "Ajouter" pour en cr√©er une.
                        </div>

                        <!-- Formulaire d'ajout (cach√© par d√©faut) -->
                        <div id="form-add-visite" class="collapsible-form hidden" th:if="${dossierCourant.visite == null}">
                            <form th:action="@{/dossiers/visite/ajouter}" method="post" class="item-card">
                                <input type="hidden" name="dossierAnnuelId" th:value="${dossierCourant.dossierAnnuelId}">
                                <input type="hidden" name="apprentiId" th:value="${apprenti.apprentiId}">
                                <div class="form-group">
                                    <label for="visite-date">Date *</label>
                                    <input type="date" id="visite-date" name="date" required>
                                </div>
                                <div class="form-group">
                                    <label for="visite-format">Format *</label>
                                    <input type="text" id="visite-format" name="format" maxlength="50" required>
                                </div>
                                <div class="form-group">
                                    <label for="visite-commentaires">Commentaires</label>
                                    <textarea id="visite-commentaires" name="commentaires" maxlength="1024"></textarea>
                                </div>
                                <div class="action-buttons">
                                    <button type="submit" class="btn btn-primary btn-small">Cr√©er</button>
                                    <button type="button" class="btn btn-secondary btn-small" onclick="toggleAddForm('visite')">Annuler</button>
                                </div>
                            </form>
                        </div>

                        <!-- Formulaire de modification (cach√© par d√©faut) -->
                        <div id="form-edit-visite" class="collapsible-form hidden" th:if="${dossierCourant.visite != null}">
                            <form th:action="@{/dossiers/visite/{visiteId}/modifier(visiteId=${dossierCourant.visite.visiteId})}" method="post" class="item-card">
                                <input type="hidden" name="dossierAnnuelId" th:value="${dossierCourant.dossierAnnuelId}">
                                <input type="hidden" name="apprentiId" th:value="${apprenti.apprentiId}">
                                <div class="form-group">
                                    <label for="visite-date-update">Date *</label>
                                    <input type="date" id="visite-date-update" name="date" required th:value="${dossierCourant.visite.date}">
                                </div>
                                <div class="form-group">
                                    <label for="visite-format-update">Format *</label>
                                    <input type="text" id="visite-format-update" name="format" maxlength="50" required th:value="${dossierCourant.visite.format}">
                                </div>
                                <div class="form-group">
                                    <label for="visite-commentaires-update">Commentaires</label>
                                    <textarea id="visite-commentaires-update" name="commentaires" maxlength="1024" th:text="${dossierCourant.visite.commentaires}"></textarea>
                                </div>
                                <div class="action-buttons">
                                    <button type="submit" class="btn btn-primary btn-small">Mettre √† jour</button>
                                    <button type="button" class="btn btn-secondary btn-small" onclick="toggleEditForm('visite')">Annuler</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="info-section">
                        <div class="section-header">
                            <div class="section-title">üé§ Soutenance</div>
                            <div>
                                <button th:if="${dossierCourant.soutenance == null}"
                                        type="button"
                                        class="btn btn-primary btn-small"
                                        onclick="toggleAddForm('soutenance')">+ Ajouter</button>
                                <button th:if="${dossierCourant.soutenance != null}"
                                        type="button"
                                        class="btn btn-primary btn-small"
                                        onclick="toggleEditForm('soutenance')">‚úèÔ∏è Modifier</button>
                                <form th:if="${dossierCourant.soutenance != null}"
                                      th:action="@{/dossiers/soutenance/{soutenanceId}/supprimer(soutenanceId=${dossierCourant.soutenance.soutenanceId})}"
                                      method="post"
                                      style="display: inline;"
                                      onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer cette soutenance ?')">
                                    <input type="hidden" name="apprentiId" th:value="${apprenti.apprentiId}">
                                    <button type="submit" class="btn btn-secondary btn-small">üóëÔ∏è Supprimer</button>
                                </form>
                            </div>
                        </div>

                        <!-- Message d'erreur contextuel pour la soutenance -->
                        <div th:if="${errorMessage != null and #strings.startsWith(errorMessage, 'SOUTENANCE:')}"
                             class="alert-error"
                             style="margin-bottom: 1rem;">
                            <span th:utext="${#strings.substringAfter(errorMessage, 'SOUTENANCE:')}"></span>
                        </div>

                        <!-- Affichage des donn√©es existantes -->
                        <div id="view-soutenance" th:if="${dossierCourant.soutenance != null}" class="item-card">
                            <div class="item-field">
                                <div class="field-label">Date :</div>
                                <div class="field-value" th:text="${#temporals.format(dossierCourant.soutenance.date, 'dd/MM/yyyy')}">-</div>
                            </div>
                            <div class="item-field" th:if="${dossierCourant.soutenance.noteFinale != null}">
                                <div class="field-label">Note finale :</div>
                                <div class="field-value" th:text="${dossierCourant.soutenance.noteFinale + '/20'}">-</div>
                            </div>
                            <div class="item-field" th:if="${dossierCourant.soutenance.commentaires != null}">
                                <div class="field-label">Commentaires :</div>
                                <div class="field-value" th:text="${dossierCourant.soutenance.commentaires}">-</div>
                            </div>
                        </div>

                        <!-- Message vide -->
                        <div th:if="${dossierCourant.soutenance == null}" class="item-empty">
                            Aucune soutenance enregistr√©e. Cliquez sur "Ajouter" pour en cr√©er une.
                        </div>

                        <!-- Formulaire d'ajout (cach√© par d√©faut) -->
                        <div id="form-add-soutenance" class="collapsible-form hidden" th:if="${dossierCourant.soutenance == null}">
                            <form th:action="@{/dossiers/soutenance/ajouter}" method="post" class="item-card">
                                <input type="hidden" name="dossierAnnuelId" th:value="${dossierCourant.dossierAnnuelId}">
                                <input type="hidden" name="apprentiId" th:value="${apprenti.apprentiId}">
                                <div class="form-group">
                                    <label for="soutenance-date">Date *</label>
                                    <input type="date" id="soutenance-date" name="date" required>
                                </div>
                                <div class="form-group">
                                    <label for="soutenance-note">Note finale</label>
                                    <input type="number" id="soutenance-note" name="noteFinale" min="0" max="20" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label for="soutenance-commentaires">Commentaires</label>
                                    <textarea id="soutenance-commentaires" name="commentaires" maxlength="1024"></textarea>
                                </div>
                                <div class="action-buttons">
                                    <button type="submit" class="btn btn-primary btn-small">Cr√©er</button>
                                    <button type="button" class="btn btn-secondary btn-small" onclick="toggleAddForm('soutenance')">Annuler</button>
                                </div>
                            </form>
                        </div>

                        <!-- Formulaire de modification (cach√© par d√©faut) -->
                        <div id="form-edit-soutenance" class="collapsible-form hidden" th:if="${dossierCourant.soutenance != null}">
                            <form th:action="@{/dossiers/soutenance/{soutenanceId}/modifier(soutenanceId=${dossierCourant.soutenance.soutenanceId})}" method="post" class="item-card">
                                <input type="hidden" name="dossierAnnuelId" th:value="${dossierCourant.dossierAnnuelId}">
                                <input type="hidden" name="apprentiId" th:value="${apprenti.apprentiId}">
                                <div class="form-group">
                                    <label for="soutenance-date-update">Date *</label>
                                    <input type="date" id="soutenance-date-update" name="date" required th:value="${dossierCourant.soutenance.date}">
                                </div>
                                <div class="form-group">
                                    <label for="soutenance-note-update">Note finale</label>
                                    <input type="number" id="soutenance-note-update" name="noteFinale" min="0" max="20" step="0.5" th:value="${dossierCourant.soutenance.noteFinale}">
                                </div>
                                <div class="form-group">
                                    <label for="soutenance-commentaires-update">Commentaires</label>
                                    <textarea id="soutenance-commentaires-update" name="commentaires" maxlength="1024" th:text="${dossierCourant.soutenance.commentaires}"></textarea>
                                </div>
                                <div class="action-buttons">
                                    <button type="submit" class="btn btn-primary btn-small">Mettre √† jour</button>
                                    <button type="button" class="btn btn-secondary btn-small" onclick="toggleEditForm('soutenance')">Annuler</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="info-section">
                        <div class="section-header">
                            <div class="section-title">üìÑ Rapport</div>
                            <div>
                                <button th:if="${dossierCourant.rapport == null}"
                                        type="button"
                                        class="btn btn-primary btn-small"
                                        onclick="toggleAddForm('rapport')">+ Ajouter</button>
                                <button th:if="${dossierCourant.rapport != null}"
                                        type="button"
                                        class="btn btn-primary btn-small"
                                        onclick="toggleEditForm('rapport')">‚úèÔ∏è Modifier</button>
                                <form th:if="${dossierCourant.rapport != null}"
                                      th:action="@{/dossiers/rapport/{rapportId}/supprimer(rapportId=${dossierCourant.rapport.rapportId})}"
                                      method="post"
                                      style="display: inline;"
                                      onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer ce rapport ?')">
                                    <input type="hidden" name="apprentiId" th:value="${apprenti.apprentiId}">
                                    <button type="submit" class="btn btn-secondary btn-small">üóëÔ∏è Supprimer</button>
                                </form>
                            </div>
                        </div>

                        <!-- Message d'erreur contextuel pour le rapport -->
                        <div th:if="${errorMessage != null and #strings.startsWith(errorMessage, 'RAPPORT:')}"
                             class="alert-error"
                             style="margin-bottom: 1rem;">
                            <span th:utext="${#strings.substringAfter(errorMessage, 'RAPPORT:')}"></span>
                        </div>

                        <!-- Affichage des donn√©es existantes -->
                        <div id="view-rapport" th:if="${dossierCourant.rapport != null}" class="item-card">
                            <div class="item-field" th:if="${dossierCourant.rapport.sujet != null}">
                                <div class="field-label">Sujet :</div>
                                <div class="field-value" th:text="${dossierCourant.rapport.sujet}">-</div>
                            </div>
                            <div class="item-field" th:if="${dossierCourant.rapport.noteFinale != null}">
                                <div class="field-label">Note finale :</div>
                                <div class="field-value" th:text="${dossierCourant.rapport.noteFinale + '/20'}">-</div>
                            </div>
                            <div class="item-field" th:if="${dossierCourant.rapport.commentaires != null}">
                                <div class="field-label">Commentaires :</div>
                                <div class="field-value" th:text="${dossierCourant.rapport.commentaires}">-</div>
                            </div>
                        </div>

                        <!-- Message vide -->
                        <div th:if="${dossierCourant.rapport == null}" class="item-empty">
                            Aucun rapport enregistr√©. Cliquez sur "Ajouter" pour en cr√©er un.
                        </div>

                        <!-- Formulaire d'ajout (cach√© par d√©faut) -->
                        <div id="form-add-rapport" class="collapsible-form hidden" th:if="${dossierCourant.rapport == null}">
                            <form th:action="@{/dossiers/rapport/ajouter}" method="post" class="item-card">
                                <input type="hidden" name="dossierAnnuelId" th:value="${dossierCourant.dossierAnnuelId}">
                                <input type="hidden" name="apprentiId" th:value="${apprenti.apprentiId}">
                                <div class="form-group">
                                    <label for="rapport-sujet">Sujet *</label>
                                    <input type="text" id="rapport-sujet" name="sujet" maxlength="255" required>
                                </div>
                                <div class="form-group">
                                    <label for="rapport-note">Note finale</label>
                                    <input type="number" id="rapport-note" name="noteFinale" min="0" max="20" step="0.5">
                                </div>
                                <div class="form-group">
                                    <label for="rapport-commentaires">Commentaires</label>
                                    <textarea id="rapport-commentaires" name="commentaires" maxlength="1024"></textarea>
                                </div>
                                <div class="action-buttons">
                                    <button type="submit" class="btn btn-primary btn-small">Cr√©er</button>
                                    <button type="button" class="btn btn-secondary btn-small" onclick="toggleAddForm('rapport')">Annuler</button>
                                </div>
                            </form>
                        </div>

                        <!-- Formulaire de modification (cach√© par d√©faut) -->
                        <div id="form-edit-rapport" class="collapsible-form hidden" th:if="${dossierCourant.rapport != null}">
                            <form th:action="@{/dossiers/rapport/{rapportId}/modifier(rapportId=${dossierCourant.rapport.rapportId})}" method="post" class="item-card">
                                <input type="hidden" name="dossierAnnuelId" th:value="${dossierCourant.dossierAnnuelId}">
                                <input type="hidden" name="apprentiId" th:value="${apprenti.apprentiId}">
                                <div class="form-group">
                                    <label for="rapport-sujet-update">Sujet *</label>
                                    <input type="text" id="rapport-sujet-update" name="sujet" maxlength="255" required th:value="${dossierCourant.rapport.sujet}">
                                </div>
                                <div class="form-group">
                                    <label for="rapport-note-update">Note finale</label>
                                    <input type="number" id="rapport-note-update" name="noteFinale" min="0" max="20" step="0.5" th:value="${dossierCourant.rapport.noteFinale}">
                                </div>
                                <div class="form-group">
                                    <label for="rapport-commentaires-update">Commentaires</label>
                                    <textarea id="rapport-commentaires-update" name="commentaires" maxlength="1024" th:text="${dossierCourant.rapport.commentaires}"></textarea>
                                </div>
                                <div class="action-buttons">
                                    <button type="submit" class="btn btn-primary btn-small">Mettre √† jour</button>
                                    <button type="button" class="btn btn-secondary btn-small" onclick="toggleEditForm('rapport')">Annuler</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const apprentiId = /*[[${apprenti.apprentiId}]]*/ 0;
        const errorMessage = /*[[${errorMessage}]]*/ null;

        // Au chargement de la page, ouvrir automatiquement le formulaire qui a une erreur
        document.addEventListener('DOMContentLoaded', function() {
            if (errorMessage) {
                if (errorMessage.startsWith('VISITE:')) {
                    const visiteForm = document.getElementById('form-add-visite') || document.getElementById('form-edit-visite');
                    if (visiteForm) {
                        visiteForm.classList.remove('hidden');
                        visiteForm.classList.add('show');
                        // Scroll vers la section
                        visiteForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else if (errorMessage.startsWith('SOUTENANCE:')) {
                    const soutenanceForm = document.getElementById('form-add-soutenance') || document.getElementById('form-edit-soutenance');
                    if (soutenanceForm) {
                        soutenanceForm.classList.remove('hidden');
                        soutenanceForm.classList.add('show');
                        soutenanceForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else if (errorMessage.startsWith('RAPPORT:')) {
                    const rapportForm = document.getElementById('form-add-rapport') || document.getElementById('form-edit-rapport');
                    if (rapportForm) {
                        rapportForm.classList.remove('hidden');
                        rapportForm.classList.add('show');
                        rapportForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        });

        function toggleAddForm(formName) {
            const formElement = document.getElementById('form-add-' + formName);
            const emptyElement = formElement.previousElementSibling;

            if (formElement.classList.contains('hidden')) {
                // Afficher le formulaire
                formElement.classList.remove('hidden');
                formElement.classList.add('show');
                if (emptyElement && emptyElement.classList.contains('item-empty')) {
                    emptyElement.classList.add('hidden');
                }
            } else {
                // Cacher le formulaire
                formElement.classList.remove('show');
                formElement.classList.add('hidden');
                if (emptyElement && emptyElement.classList.contains('item-empty')) {
                    emptyElement.classList.remove('hidden');
                }
            }
        }

        function toggleEditForm(formName) {
            const formElement = document.getElementById('form-edit-' + formName);
            const viewElement = document.getElementById('view-' + formName);

            if (formElement.classList.contains('hidden')) {
                // Afficher le formulaire de modification et cacher la vue
                formElement.classList.remove('hidden');
                formElement.classList.add('show');
                if (viewElement) {
                    viewElement.classList.add('hidden');
                }
            } else {
                // Cacher le formulaire et afficher la vue
                formElement.classList.remove('show');
                formElement.classList.add('hidden');
                if (viewElement) {
                    viewElement.classList.remove('hidden');
                }
            }
        }

        function toggleEdit(section) {
            const sectionElement = document.getElementById('section-' + section);
            const isInViewMode = sectionElement.classList.contains('view-mode');

            if (isInViewMode) {
                // Passer en mode √©dition
                sectionElement.classList.remove('view-mode');
                sectionElement.classList.add('edit-mode');
                sectionElement.querySelector('.view-content').classList.add('hidden');
                sectionElement.querySelector('.edit-content').classList.remove('hidden');
                sectionElement.querySelector('.edit-text').classList.add('hidden');
                sectionElement.querySelector('.save-text').classList.remove('hidden');
            } else {
                // Sauvegarder et retourner en mode consultation
                saveSection(section);
            }
        }

        function cancelEdit(section) {
            const sectionElement = document.getElementById('section-' + section);

            // Retourner en mode consultation
            sectionElement.classList.remove('edit-mode');
            sectionElement.classList.add('view-mode');
            sectionElement.querySelector('.view-content').classList.remove('hidden');
            sectionElement.querySelector('.edit-content').classList.add('hidden');
            sectionElement.querySelector('.edit-text').classList.remove('hidden');
            sectionElement.querySelector('.save-text').classList.add('hidden');
        }

        function saveSection(section) {
            if (section === 'entreprise') {
                saveEntreprise();
            } else if (section === 'maitre') {
                saveMaitreApprentissage();
            }
        }

        function saveEntreprise() {
            const entrepriseId = document.getElementById('entreprise').value;

            // Cr√©er un formulaire pour envoyer les donn√©es
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/apprentis/${apprentiId}/entreprise`;

            // Ajouter le champ _method pour PATCH
            const methodInput = document.createElement('input');
            methodInput.type = 'hidden';
            methodInput.name = '_method';
            methodInput.value = 'PATCH';
            form.appendChild(methodInput);

            // Ajouter l'ID de l'entreprise
            if (entrepriseId) {
                const entrepriseInput = document.createElement('input');
                entrepriseInput.type = 'hidden';
                entrepriseInput.name = 'entrepriseId';
                entrepriseInput.value = entrepriseId;
                form.appendChild(entrepriseInput);
            }

            document.body.appendChild(form);
            form.submit();
        }

        function saveMaitreApprentissage() {
            const maitreId = document.getElementById('maitre').value;

            // Cr√©er un formulaire pour envoyer les donn√©es
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/apprentis/${apprentiId}/maitre-apprentissage`;

            // Ajouter le champ _method pour PATCH
            const methodInput = document.createElement('input');
            methodInput.type = 'hidden';
            methodInput.name = '_method';
            methodInput.value = 'PATCH';
            form.appendChild(methodInput);

            // Ajouter l'ID du ma√Ætre
            if (maitreId) {
                const maitreInput = document.createElement('input');
                maitreInput.type = 'hidden';
                maitreInput.name = 'maitreApprentissageId';
                maitreInput.value = maitreId;
                form.appendChild(maitreInput);
            }

            document.body.appendChild(form);
            form.submit();
        }

        function redirectToNouvelleEntreprise() {
            // Sauvegarder l'ID de l'apprenti en session si n√©cessaire
            window.location.href = '/entreprises/nouveau?returnTo=apprentis/' + apprentiId + '/gerer';
        }

        function redirectToNouveauMaitre() {
            // Sauvegarder l'ID de l'apprenti en session si n√©cessaire
            window.location.href = '/maitre-apprentissage/nouveau?returnTo=apprentis/' + apprentiId + '/gerer';
        }
        /*]]>*/
    </script>

</body>
</html>
